<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>RGB Color Tolerance Test</title></head>
<body onload="updateColorDifference();updatColorPanel(0, 32);">
  <div id="color-difference">
    <label for="color1">Color 1: 0x</label>
    <input type="text" id="color1" size="6" pattern="^([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$"
           value="000000" onchange="updateColorDifference();" />
    <span> &nbsp; </span>
    <label for="color2">Color 2: 0x</label>
    <input type="text" id="color2" size="6" pattern="^([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$"
           value="FFFFFF" onchange="updateColorDifference();" />
    <span> &nbsp; </span>
    <input type="button" value="Random" onclick="randomColors();" />
    <span> &nbsp; </span>
    <label for="color2">Color difference:</label>
    <span id="span1" style="border: 1px solid;"> &nbsp; </span>
    <span>&nbsp;VS</span>
    <span id="span2" style="border: 1px solid;"> &nbsp; </span>
    <span> &nbsp; </span>
    <code id="colors-info"></code>
  </div>
  <hr />
  <div id="color-panel">
    <label for="color">Central Color: 0x</label>
    <input type="text" id="color" size="6" pattern="^([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$"
           value="000000" onchange="updatColorPanel();" />
    <input type="button" value="Random" onclick="randomColor();" />
    <code id="color-info"></code>
    <label for="tolerance">Color Tolerance:</label>
    <input type="number" id="tolerance" size="3" min="1" max="256"
           value="32" onchange="updatColorPanel();" />
    <div style="border:1px solid; overflow-x:scroll;">
      <canvas id="colorPanel"></canvas>
    </div>
  </div>
  <script id="random-colors">
    /**
     * Generate two random colors to calculate the color difference
     */
    function randomColors() {
      var color1 = Math.floor(Math.random() * 16777216);
      var str = color1.toString(16).toUpperCase();
      while (str.length < 6)
        str = '0' + str;
      document.getElementById('color1').value = str;
      var color2 = Math.floor(Math.random() * 16777216);
      str = color2.toString(16).toUpperCase();
      while (str.length < 6)
        str = '0' + str;
      document.getElementById('color2').value = str;
      updateColorDifference();
    } // function randomColors()
  </script>
  <script id="update-color-difference">
    /**
     * Re-calculate the color difference
     */
    function updateColorDifference() {
      var str1 = document.getElementById('color1').value;
      if (str1.length == 3)
        str = str[0] + str[0] + str[1] + str[1] + str[2] + str[2];
      var str2 = document.getElementById('color2').value;
      if (str2.length == 3)
        str = str[0] + str[0] + str[1] + str[1] + str[2] + str[2];
      document.getElementById('span1').style.backgroundColor = '#' + str1;
      document.getElementById('span2').style.backgroundColor = '#' + str2;

      var color1 = parseInt(str1, 16);
      var color2 = parseInt(str2, 16);
      var r1 = Math.floor(color1 / 65536), g1 = Math.floor((color1 % 65536) / 256), b1 = color1 % 256;
      var r2 = Math.floor(color2 / 65536), g2 = Math.floor((color2 % 65536) / 256), b2 = color2 % 256;
      var rgbDiff = Math.max(Math.abs(r1 - r2), Math.abs(g1 - g2), Math.abs(b1 - b2));
      var deltaE = deltaE_CIE2000(RGBtoLAB([r1, g1, b1]), RGBtoLAB([r2, g2, b2]));
      var eucDist = Math.sqrt(Math.pow(r1 - r2, 2) + Math.pow(g1 - g2, 2) + Math.pow(b1 - b2, 2));
      document.getElementById('colors-info').innerHTML = 'RGB(' + r1 + ', ' + g1 + ', ' + b1 + ') : RGB('
                                                                + r2 + ', ' + g2 + ', ' + b2 + ') -- ' +
                                                         'RGB_DIFF=' + rgbDiff + '; EuclDist=' + eucDist +
                                                         '; DeltaE_2000=' + deltaE;
    } // function updateColorDifference()
  </script>
  <script id="color-libraries">
    /**
     * Assume all inputs are valid
     * http://www.brucelindbloom.com/index.html?Math.html
     * RGB is sRGB
     * Illuminant D65: xr = 0.95047, yr = 1.00000, zr = 1.08883
     */
    function RGBtoLAB(rgb) {
      for (c in rgb) {
        rgb[c] /= 255.0;
        rgb[c] = (rgb[c] > 0.04045) ? Math.pow((rgb[c] + 0.055)/1.055, 2.4) : rgb[c]/12.92;
      } // for (c in rgb)
      var xyz = [(0.4124564 * rgb[0] + 0.3575761 * rgb[1] + 0.1804375 * rgb[2]) / 0.95047,
                 (0.2126729 * rgb[0] + 0.7151522 * rgb[1] + 0.0721750 * rgb[2]) / 1.00000,
                 (0.0193339 * rgb[0] + 0.1191920 * rgb[1] + 0.9503041 * rgb[2]) / 1.08883];
      for (c in xyz)
        xyz[c] = (xyz[c] > 0.008856) ? Math.pow(xyz[c], 1.0/3.0) : (903.3 * xyz[c] + 16.0) / 116.0;
      return [116.0 * xyz[1] - 16.0, 500.0 * (xyz[0] - xyz[1]), 200.0 * (xyz[1] - xyz[2])];
    } // function RGBtoLAB(rgb)
    /**
     * Assume all inputs are valid
     * http://www.brucelindbloom.com/index.html?Eqn_DeltaE_CIE2000.html
     */
    function deltaE_CIE2000(lab1, lab2) {
      var l_avg = (lab1[0] + lab2[0]) / 2.0, l_delta_p = lab2[0] - lab1[0];
      var s_l = Math.pow(l_avg - 50.0, 2.0);
      s_l = 1.0 + (0.015 * s_l) / (Math.sqrt(20.0 + s_l));
      var c1 = Math.sqrt(lab1[1] * lab1[1] + lab1[2] * lab1[2]), c2 = Math.sqrt(lab2[1] * lab2[1] + lab2[2] * lab2[2]);
      var c_avg = Math.pow((c1 + c2) / 2.0, 7.0), g = (1.0 - Math.sqrt(c_avg / (c_avg + Math.pow(25.0, 7.0)))) / 2.0;
      lab1[1] *= (1.0 + g);
      lab2[1] *= (1.0 + g);
      c1 = Math.sqrt(lab1[1] * lab1[1] + lab1[2] * lab1[2]);
      c2 = Math.sqrt(lab2[1] * lab2[1] + lab2[2] * lab2[2]);
      c_avg = (c1 + c2) / 2.0;
      var c_delta_p = c2 - c1, s_c = 1.0 + 0.045 * c_avg;
      var h1 = Math.atan2(lab1[2], lab1[1]) / Math.PI * 180.0;
      if (h1 < 0.0)
        h1 += 360.0;
      var h2 = Math.atan2(lab2[2], lab2[1]) / Math.PI * 180.0;
      if (h2 < 0.0)
        h2 += 360.0;
      var h_delta = h2 - h1, h_avg = (h1 + h2) / 2.0;
      if (Math.abs(h_delta) > 180.0) {
        h_delta = (h2 > h1) ? h_delta - 360.0 : h_delta + 360.0;
        h_avg += 180.0;
      } // if (Math.abs(h_delta) > 180.0)
      var t = 1.0 - 0.17 * Math.cos((h_avg - 30.0) / 180.0 * Math.PI)
                  + 0.24 * Math.cos((2.0 * h_avg) / 180.0 * Math.PI)
                  + 0.32 * Math.cos((3.0 * h_avg + 6.0) / 180.0 * Math.PI)
                  - 0.20 * Math.cos((4.0 * h_avg - 63.0) / 180.0 * Math.PI);
      var h_delta_p = 2.0 * Math.sqrt(c1 * c2) * Math.sin(h_delta / 360.0 * Math.PI);
      var s_h = 1.0 + 0.0015 * c_avg * t;
      var theta_delta = 30.0 * Math.exp(-1.0 * Math.pow((h_avg - 275) / 25.0, 2.0));
      c_avg = Math.pow(c_avg, 7.0);
      var r_c = 2.0 * Math.sqrt(c_avg / (c_avg + Math.pow(25.0, 7.0)));
      var r_t = -1.0 * r_c * Math.sin(2.0 * theta_delta / 180.0 * Math.PI);
      var deltaE = Math.sqrt(Math.pow(l_delta_p / s_l, 2.0) +
                             Math.pow(c_delta_p / s_c, 2.0) +
                             Math.pow(h_delta_p / s_h, 2.0) +
                             r_t * (c_delta_p / s_c) * (h_delta_p / s_h));
      return deltaE;
    } // function deltaE_CIE2000(lab1, lab2)
  </script>
  <script id="random-color">
    /**
     * Generate a random color, and update the web page
     */
    function randomColor() {
      var color = Math.floor(Math.random() * 16777216);
      var str = color.toString(16).toUpperCase();
      while (str.length < 6)
        str = '0' + str;
      document.getElementById('color').value = str;
      updatColorPanel();
    } // function randomColor()
  </script>
  <script id="update-color-panel">
    /**
     * Re-draw the color panel
     */
    function updatColorPanel() {
      var width = 3, margin = 1, cols = 10;
      var str = document.getElementById('color').value;
      if (str.length == 3)
        str = str[0] + str[0] + str[1] + str[1] + str[2] + str[2];
      var color = parseInt(str, 16);
      var tolerance = parseInt(document.getElementById('tolerance').value);
      var red = Math.floor(color / 65536);
      var green = Math.floor((color % 65536) / 256);
      var blue = color % 256;
      document.getElementById('color-info').innerHTML = 'RGB(' + red + ', ' + green + ', ' + blue + ')';
      var half = Math.floor(tolerance / 2);
      var r1 = red - half < 0       ? 0 : red - half;
      var g1 = green - half < 0     ? 0 : green - half;
      var b1 = blue - half < 0      ? 0 : blue - half;
      if (Math.floor(tolerance / 2) != tolerance / 2)
        half ++;
      var r2 = red + half > 256     ? 256 : red + half;
      var g2 = green + half > 256   ? 256 : green + half;
      var b2 = blue + half > 256    ? 256 : blue + half;
      if (r1 < 0)   r1 = 0;
      if (g1 < 0)   g1 = 0;
      if (b1 < 0)   b1 = 0;

      var c = document.getElementById('colorPanel');
      var cWidth = (b2 - b1 + 1) * (width + margin) * cols;
      var cHeight = Math.ceil(tolerance / cols) * (g2 - g1 + 1) * (width + margin);
      c.width = cWidth;
      c.height = cHeight;
      var ctx = c.getContext('2d');
      ctx.fillStyle = '#FFF';
      ctx.fillRect(0, 0, cWidth, cHeight);
      var left = 0, top = 0;
      for (var r = r1; r < r2; r++) {
        for (var g = g1, y = margin; g < g2; g++, y += width + margin) {
          for (var b = b1, x = margin; b < b2; b++, x += width + margin) {
            ctx.fillStyle = 'rgb(' + r + ',' + g + ',' + b +')';
            ctx.fillRect(x + left, y + top, width, width);
          } // for (var b = b1, x = margin; b < b2; b++, x += width + margin)
        } // for (var g = g1, y = margin; g < g2; g++, y += width + margin)
        left += (width + margin) * (b2 - b1 + 1);
        if ((r - r1) % 10 == 9) {
          left = 0;
          top += (width + margin) * (g2 - g1 + 1);
        } // if (left + (width + margin) * (b2 - b1 + 1) > 1024)
      } // for (var r = r1; r < r2; r++)
    } // function updatColorPanel(color, tolerance)
  </script>
</body>
</html>
